name: 'Setup Android Build'
description: 'Setup Android build environment with Gradle, Ruby, and Fastlane'
inputs:
  java-version:
    description: 'Java version to use'
    required: false
    default: '17'
runs:
  using: 'composite'
  steps:
    - name: Validate Gradle wrapper
      uses: gradle/actions/wrapper-validation@017a9effdb900e5b5b2fddfb590a105619dca3c3 # v4.4.2

    - name: Cache Gradle files
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-v2-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
        restore-keys: |
          ${{ runner.os }}-gradle-v2-

    - name: Cache build output
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809 # v4.2.4
      with:
        path: |
          ${{ github.workspace }}/build-cache
        key: ${{ runner.os }}-build-cache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-build-

    - name: Configure Ruby
      uses: ruby/setup-ruby@829114fc20da43a41d27359103ec7a63020954d4 # v1.255.0
      with:
        bundler-cache: true

    - name: Configure JDK
      uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
      with:
        distribution: "temurin"
        java-version: ${{ inputs.java-version }}

    - name: Install Fastlane
      shell: bash
      run: |
        gem install bundler:2.2.27
        bundle config path vendor/bundle
        bundle install --jobs 4 --retry 3
